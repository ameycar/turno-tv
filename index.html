<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Turnos - Centro MÃ©dico DR. Luis Quito</title>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(120deg, #f4f8fb, #e9eef2);
      display: flex;
      height: 100vh;
      overflow: hidden;
      color: #1a1a1a;
    }

    /* Panel del video */
    .video-panel {
      flex: 2;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Panel de turnos */
    .turnos-panel {
      flex: 1;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-left: 6px solid #d32f2f;
      position: relative;
    }

    header {
      text-align: center;
      background: #d32f2f;
      color: white;
      padding: 15px 10px;
      font-size: 1.3rem;
      font-weight: bold;
      position: relative;
    }

    /* Selector de sede */
    #sedeSelect {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 5px 8px;
      font-size: 0.9rem;
      border-radius: 6px;
      border: none;
      background: #ffffff;
      color: #1a1a1a;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    main {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .paciente {
      background: #f5f5f5;
      border-radius: 10px;
      margin-bottom: 10px;
      padding: 12px 16px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .paciente.en-espera { border-left: 5px solid #f44336; }
    .paciente.en-atencion { border-left: 5px solid #ff9800; }
    .paciente.atendido { border-left: 5px solid #4caf50; }

    .paciente strong {
      display: block;
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    footer {
      background: #0d47a1;
      color: white;
      text-align: center;
      padding: 10px;
      font-size: 0.9rem;
    }

    #ultimosLlamados {
      background: #f0f4f8;
      padding: 10px;
      border-top: 2px solid #ccc;
    }

    button#llamarBtn {
      display: block;
      margin: 0 auto 10px auto;
      background: #1976d2;
      color: white;
      padding: 8px 18px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }

    button#llamarBtn:hover {
      background: #0d47a1;
    }
  </style>
</head>
<body>
  <div class="video-panel">
    <video id="videoPublicidad" autoplay muted loop>
      <source src="video.mp4" type="video/mp4" />
      Tu navegador no soporta video.
    </video>
  </div>

  <div class="turnos-panel">
    <header>
      Centro MÃ©dico DR. Luis Quito
      <select id="sedeSelect">
        <option value="">Cargando sedes...</option>
      </select>
    </header>

    <main id="listaPacientes">
      <p style="text-align:center;">Cargando pacientes...</p>
    </main>

    <div id="ultimosLlamados">
      <button id="llamarBtn">ðŸ”Š Llamar siguiente</button>
      <div id="ultimos"></div>
    </div>

    <footer>Â© 2025 Centro MÃ©dico DR. Luis Quito</footer>
  </div>

  <audio id="sonidoTimbre" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script type="module">
    import { db } from "./firebase-config.js";
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const sedeSelect = document.getElementById("sedeSelect");
    const listaPacientes = document.getElementById("listaPacientes");
    const ultimosDiv = document.getElementById("ultimos");
    const llamarBtn = document.getElementById("llamarBtn");
    const sonido = document.getElementById("sonidoTimbre");
    const videoPublicidad = document.getElementById("videoPublicidad");

    let sedeSeleccionada = localStorage.getItem("sedeSeleccionada") || "";
    let pacientes = [];
    let sedes = {};

    // ðŸ”¹ Cargar sedes activas y sus videos
    const sedesRef = ref(db, "sedes");
    onValue(sedesRef, (snapshot) => {
      sedeSelect.innerHTML = "";
      sedes = snapshot.val() || {};
      for (let sede in sedes) {
        if (sedes[sede].activo) {
          const opt = document.createElement("option");
          opt.value = sede;
          opt.textContent = sede;
          sedeSelect.appendChild(opt);
        }
      }
      if (sedeSeleccionada) {
        sedeSelect.value = sedeSeleccionada;
        actualizarVideo();
      }
    });

    // ðŸ”¹ Cambiar sede
    sedeSelect.addEventListener("change", () => {
      sedeSeleccionada = sedeSelect.value;
      localStorage.setItem("sedeSeleccionada", sedeSeleccionada);
      filtrarPacientes();
      actualizarVideo();
    });

    // ðŸ”¹ Actualizar video dinÃ¡micamente
    function actualizarVideo() {
      if (sedeSeleccionada && sedes[sedeSeleccionada]?.videoUrl) {
        videoPublicidad.src = sedes[sedeSeleccionada].videoUrl;
        videoPublicidad.load();
        videoPublicidad.play();
      }
    }

    // ðŸ”¹ Cargar pacientes
    const pacientesRef = ref(db, "pacientes");
    onValue(pacientesRef, (snapshot) => {
      pacientes = [];
      snapshot.forEach((child) => pacientes.push(child.val()));
      filtrarPacientes();
    });

    function filtrarPacientes() {
      if (!sedeSeleccionada) {
        listaPacientes.innerHTML = "<p style='text-align:center;'>Seleccione una sede</p>";
        return;
      }
      const filtrados = pacientes.filter(p => p.sede === sedeSeleccionada);
      mostrarPacientes(filtrados);
    }

    function mostrarPacientes(lista) {
      listaPacientes.innerHTML = "";
      if (lista.length === 0) {
        listaPacientes.innerHTML = "<p style='text-align:center;'>No hay pacientes</p>";
        return;
      }
      lista.forEach(p => {
        const div = document.createElement("div");
        div.className = `paciente ${p.estado?.toLowerCase().replace(" ", "-") || ""}`;
        div.innerHTML = `<strong>${p.nombres} ${p.apellidos}</strong>${p.estudio || ""}`;
        listaPacientes.appendChild(div);
      });
    }

    // ðŸ”Š Llamar siguiente paciente
    llamarBtn.addEventListener("click", () => {
      const siguiente = pacientes.find(p => p.sede === sedeSeleccionada && p.estado === "En atenciÃ³n");
      if (siguiente) {
        sonido.play();
        const texto = `Siguiente turno: ${siguiente.nombres} ${siguiente.apellidos}, Ã¡rea de ${siguiente.estudio}`;
        const voz = new SpeechSynthesisUtterance(texto);
        voz.lang = "es-PE";
        speechSynthesis.speak(voz);
        ultimosDiv.innerHTML = `<p><strong>${siguiente.nombres} ${siguiente.apellidos}</strong> - ${siguiente.estudio}</p>` + ultimosDiv.innerHTML;
      } else {
        alert("No hay pacientes en atenciÃ³n para llamar.");
      }
    });
  </script>
</body>
</html>
